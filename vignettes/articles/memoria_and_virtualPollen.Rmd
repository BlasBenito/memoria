---
title: "memoria and virtualPollen"
output:
  rmarkdown::html_document:
    toc: true
    toc_title: "Content"
    source: false
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 9,
  fig.height = 4,
  out.width = "100%"
)
```

## Introduction

The [virtualPollen](https://github.com/BlasBenito/virtualPollen) package generates synthetic pollen abundance curves by simulating virtual taxa with configurable life-history traits (maximum age, fecundity) and niche characteristics (optimum, breadth). Combined with memoria, this creates a powerful framework for systematically exploring how species traits modulate ecological memory patterns.

This article demonstrates how to run batch memory analyses across multiple virtual taxa using `memoria`'s experiment functions. For methodological details, see:

> Benito, B.M., Gil-Romera, G. and Birks, H.J.B. (2020). *Ecological memory at millennial time-scales: the importance of data constraints, species longevity and niche features.* Ecography, 43: 1-10. [https://doi.org/10.1111/ecog.04772](https://doi.org/10.1111/ecog.04772)

## Setup

```{r install-deps, include = FALSE}
for (pkg in c("knitr", "dplyr", "virtualPollen", "DT")) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}
library(knitr)
```


```{r load-packages, message = FALSE, warning = FALSE}
library(memoria)
library(virtualPollen)
library(ggplot2)
library(dplyr)
```

## The virtualPollen Package

`virtualPollen` simulates pollen abundance curves using a population dynamics model where virtual taxa have configurable traits (life-span, fecundity, growth rate), environmental drivers influence population dynamics through species-specific response functions, and niche parameters define how each taxon responds to environmental gradients.

Key trait parameters and their expected effects on memory:

| Parameter | Description | Expected Memory Effect |
|-----------|-------------|----------------------|
| `maximum.age` | Maximum lifespan of individuals | Longer life → extended endogenous memory |
| `fecundity` | Number of offspring per reproductive event | Affects population recovery dynamics |
| `niche.A.sd` | Niche breadth (standard deviation) | Broader niche → weaker exogenous memory |
| `niche.A.mean` | Niche optimum position | Determines driver response curve |

## Understanding the Data

The `virtualPollen` package provides two example datasets: `parameters` and `simulation`.

The `virtualPollen::parameters` dataframe describes the traits of the simulated species. Note the contrast between short-lived (`maximum.age = 10`) and long-lived (`maximum.age = 1000`) taxa, and between high (`fecundity = 10`) and low (`fecundity = 1`) fecundity.

```{r explore-parameters}
data(parameters, package = "virtualPollen")
dplyr::glimpse(parameters)
```

The `virtualPollen::simulation` dataset is a list containing simulated populations generated by `virtualPollen::simulatePopulation()` using `parameters` as input.

```{r explore-simulation}
data(simulation, package = "virtualPollen")
str(simulation, max.level = 1)
```
Each element is a dataframe with the results of a mechanistic simulation. The plot below shows a small section and subset of variables from the first simulated time series.

```{r, fig.width=8, fig.height=4}
simulation[[1]] |> 
  dplyr::filter(
    Time > 500 & Time < 1500
  ) |> 
  dplyr::select(
    Time,
    Pollen,
    Driver.A
  ) |> 
  distantia::tsl_init(
    time_column = "Time"
    ) |> 
  distantia::tsl_plot(
    ylim = "relative",
    guide = FALSE
    )
```

## Batch Memory Analysis with `memoria::runExperiment()`

The `runExperiment()` function applies the full `memoria` workflow across multiple virtual taxa and sampling resolutions:

```{r run-experiment, message = FALSE, results = "hide"}
experiment <- memoria::runExperiment(
  simulations.file = simulation,
  parameters.file = parameters,
  parameters.names = c(
    "maximum.age",
    "fecundity"
  ),
  driver.column = "Driver.A",
  response.column = "Pollen",
  time.column = "Time",
  lags = seq(10, 120, by = 10),
  repetitions = 30
)
```

## Visualizing Results with plotExperiment()

The `plotExperiment()` function generates faceted plots showing memory patterns across all analyzed taxa:

```{r plot-experiment, fig.width=8, fig.height = 6, warning = FALSE}
memoria::plotExperiment(
  experiment.output = experiment,
  parameters.file = parameters,
  R2 = TRUE
)
```

Interpreting the plot:

- **Lines**: Median importance across repetitions.
- **Ribbons**: 5th-95th percentile confidence intervals.
- **Facets**: Each panel shows a different taxon with its trait values.
- **Colors**: Different memory components (response = endogenous, driver = exogenous, random = significance baseline).
- **R2 values**: Model fit (pseudo R-squared from Random Forest).

When importance exceeds the random baseline, that memory component explains variation in pollen abundance better than chance.

## Converting to Table Format

The `experimentToTable()` function reshapes experiment results into a long-format dataframe for further analysis:

```{r experiment-to-table}
experiment_table <- experimentToTable(
  experiment.output = experiment,
  parameters.file = virtualPollen::parameters
)

dplyr::glimpse(experiment_table)
```


The output includes:

- **Variable**, **Lag**: Memory component and time lag.
- **median**, **min**, **max**: Importance statistics across repetitions.
- **R2mean**, **R2sd**: Model fit statistics.
- **VIFmean**, **VIFsd**: Variance Inflation Factor (multicollinearity diagnostic; values > 5 indicate high collinearity).

## Extracting Memory Features

The `extractMemoryFeatures()` function can process output from `experimentToTable()` to compute the eight memory features for each taxon:

```{r extract-features-batch}
# Extract features from experiment table
features <- extractMemoryFeatures(
  memory.pattern = experiment_table,
  exogenous.component = "Driver.A",
  endogenous.component = "Pollen"
)
```

```{r, echo = FALSE}
DT::datatable(features) |> 
  DT::formatRound(
    columns = c(
      "strength.endogenous", 
      "strength.exogenous", 
      "strength.concurrent"
    ), digits = 2
  ) |>
  DT::formatRound(
    columns = c(
      "length.endogenous", 
      "length.exogenous"
    ),
    digits = 3
  )
```


The eight features (organized in three groups):

**Strength** (scaled 0-1): Peak importance relative to random baseline.

- `strength.endogenous`: How strongly past pollen predicts current pollen.
- `strength.exogenous`: How strongly past environment predicts current pollen.
- `strength.concurrent`: How strongly current environment predicts current pollen.

**Length** (proportion 0-1): How far into the past memory extends above baseline.

- `length.endogenous`: Temporal extent of significant endogenous memory.
- `length.exogenous`: Temporal extent of significant exogenous memory.

**Dominance** (proportion 0-1): Which component prevails across significant lags.

- `dominance.endogenous`: Proportion of lags where endogenous > exogenous.
- `dominance.exogenous`: Proportion of lags where exogenous > endogenous.



## Summary

The integration of virtualPollen and memoria enables systematic exploration of ecological memory:

1. **virtualPollen** generates synthetic pollen curves with known trait parameters.
2. **`runExperiment()`** applies the memoria workflow across multiple taxa/resolutions.
3. **`plotExperiment()`** visualizes memory patterns in faceted plots.
4. **`experimentToTable()`** converts results to analyzable long format.
5. **`extractMemoryFeatures()`** quantifies the eight memory features.

This framework revealed that **life-span and niche features fundamentally shape ecological memory patterns**, with important implications for interpreting palaeoecological records and climate reconstructions.

For complete methodological details and extended analysis, see:

> Benito, B.M., Gil-Romera, G. and Birks, H.J.B. (2020). Ecological memory at millennial time-scales: the importance of data constraints, species longevity and niche features. Ecography, 43: 1-10. [https://doi.org/10.1111/ecog.04772](https://doi.org/10.1111/ecog.04772)
