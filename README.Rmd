---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# memoria

  <!-- badges: start -->
[![CRAN_Release_Badge](http://www.r-pkg.org/badges/version-ago/memoria)](https://CRAN.R-project.org/package=memoria)
[![CRAN_Download_Badge](http://cranlogs.r-pkg.org/badges/grand-total/memoria)](https://CRAN.R-project.org/package=memoria)
[![R-CMD-check](https://github.com/blasbenito/memoria/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/blasbenito/memoria/actions/workflows/R-CMD-check.yaml)
 <!-- badges: end -->

The **memoria** package quantifies ecological memory in long time-series involving environmental drivers and biotic responses. It uses Random Forest models to measure the relative importance of endogenous memory (effect of past response values), exogenous memory (effect of past driver values), and concurrent effects (synchronic driver influence).

## Installation

Install from CRAN:

```{r, eval = FALSE}
install.packages("memoria")
```

Or the development version from GitHub:

```{r, eval = FALSE}
devtools::install_github("BlasBenito/memoria")
```

## Quick Example

This minimal example uses built-in data to demonstrate the core workflow.

```{r, message = FALSE, warning = FALSE}
library(memoria)
library(distantia)
library(dplyr)
```


### Example Data

The `palaeodata` dataset contains is a palaeoecological dataset with pollen counts (non-integer because the data was interpolated to a regular grid, see `mergePalaeoData()`) for several taxa and several climate variables.

```{r}
data(palaeodata)
dplyr::glimpse(palaeodata)
```

For this example we select one of the plant species and two climate variables.

```{r, fig.width=8, fig.height=4}
#subset variables of interest
df <- palaeodata |> 
  dplyr::transmute(
    pinus = pollen.pinus,
    temperature = climate.temperatureAverage,
    rain = climate.rainfallAverage,
    time = age
  )

#time series plot
df |>  
  distantia::tsl_init(
  time_column = "time"
) |> 
  distantia::tsl_plot(
    ylim = "relative",
    guide = FALSE
  )
```
Notice that in the plot above, time, in thousands of years before present, goes from right (oldest) to left (newest).

The next step requires building a lagged version of the data, in which each value of the response and the predictors (drivers) is matched with previous values.


```{r}
#lag in ka
#"by" must match the resolution of df
lags <- seq(from = 0.2, to = 5, by = 0.2)

df_lags <- memoria::prepareLaggedData(
  input.data = df,
  response = "pinus",
  drivers = c(
    "temperature", 
    "rain"
    ),
  time = "time",
  oldest.sample = "last",
  lags = lags
)

dplyr::glimpse(df_lags)
```

Lets plot three of these lags to see how they look:

```{r, fig.width=8, fig.height=4}
distantia::zoo_plot(
  x = zoo::zoo(
    x = df_lags[1:100, c("pinus__0", "pinus__1", "pinus__2")],
    order.by = df_lags$time[1:100]
  ),
  xlab = "Age (ka BP)"
)
```

### Ecological Memory Analysis

The function `computeMemory()` trains Random Forest models with the lagged data, using "pinus_0" as response, all other variables as predictors, and a randomly generated variable for significance testing.


```{r example, message = FALSE, warning = FALSE}
memory <- memoria::computeMemory(
  lagged.data = df_lags,
  repetitions = 10,
  num.threads = parallel::detectCores() - 1
)
```

The output object is a list with the response, the drivers, the ecological memory analysis, the pseudo R-squared of the model predictions, and the prediction stats.

```{r}
names(memory)
```

```{r}
dplyr::glimpse(memory$memory)
```
The output of `computeMemory()` can be plotted with `plotMemory()`.

```{r, fig.width=8, fig.height=4, warning = FALSE}
memoria::plotMemory(
  memory, 
  ribbon = TRUE
  )
```

The plot shows all ecological memory components of this dataset.

- **Endogenous memory** ("pinus" curve): shows the importance of the past pollen abundance in predicting current pollen abundance. The plot shows this is the most important ecological memory component in this dataset.

- **Significance test** ("random" curve): shows the importance of 10 random autocorrelated variables to predict the response "pinus". Helps to know when a given memory component explains the response better or worse than random.

- **Concurrent effect** ("temperature" and "rain" at lag 0): importance of the current driver values to predict the response. Both drivers are below the "random" curve, indicating that the concurrent effect is negligible in this dataset. 

- **Exogenouos memory** ("temperature" and "rain" at lag > 0): importance of the past driver values in explaining the current response values. 

## Learn More

- **[Quick Start Guide](https://blasbenito.github.io/memoria/articles/quick_start.html)**: Full workflow from raw data to memory features
- **[Using memoria](https://blasbenito.github.io/memoria/articles/using_memoria.html)**: Detailed explanation of methods and theory
- **[Function Reference](https://blasbenito.github.io/memoria/reference/index.html)**: Documentation for all exported functions

## How to cite memoria

If you use **memoria** in your research, please cite both the package and the associated paper:

**Paper:**

> Benito, B.M., Gil-Romera, G., & Birks, H.J.B. (2020). Ecological memory at millennial time-scales: the importance of data constraints, species longevity, and niche features. *Ecography*, 43(1), 1-10. doi: [10.1111/ecog.04772](https://doi.org/10.1111/ecog.04772)

**R package:**

> Benito, B.M. (2025). memoria: Quantifying Ecological Memory in Palaeoecological Datasets and Other Long Time-Series. R package version 1.1.0. doi: [10.32614/CRAN.package.memoria](https://doi.org/10.32614/CRAN.package.memoria)
